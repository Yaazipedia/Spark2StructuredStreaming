1~lg_mcm_adb_cntnt~lg_load~lg_load_sql~insert overwrite table lg_base.lg_mcm_adb_cntnt partition (load_date) select a.az_prod_sk, a.az_prod_id, a.product, b.cal_dt, a.target, a.sitename, a.site_sub_sec, a.dma_nm, a.dma_cd, c.source_cd, c.source_desc, a.geo_seg_cntry_id, a.geo_seg_state_id, a.referrer_type, a.tracking_code, a.media_cmpgn, a.media_pubsr, a.media_plcmt, a.media_crtv, case when a.brnd_flg_sk =1 then 'branded' when a.brnd_flg_sk=2 then 'unbranded' end as brnd_flg_desc, a.unq_vstrs, a.visits, a.total_sec_on_site, a.page_views, a.bounces, a.time_per_visit, a.exit_conf, a.video_view_instc, a.download_instc, a.share_event_instc, a.vac_actvtn_page, a.vac_cnsdrtn_page, a.email_instc, a.regstn_instc, 'adobe' as src_sys_nm, '${bus_date}' as load_date from edh_dsl.dsl_adb_cntnt as a left join edh_dsl.dds_cal_d as b on a.cal_dt_sk=b.cal_sk left join edh_dsl.dsl_adb_source as c on a.source=c.source~kjfg254~2017-06-10 21:54:49.042958000
2~lg_mcm_adb_cntnt~lg_load~hive_compute_stats~select 1;~kjfg254~2017-06-10 21:54:50.785337000
3~lg_mcm_adb_cntnt~lg_load~hive_sql_parameters~set hive.exec.dynamic.partition.mode=strict; set hive.enforce.bucketing=false; set hive.exec.max.dynamic.partitions.pernode=10000000; set hive.exec.max.created.files=10000000; set hive.optimize.bucketmapjoin=false; set hive.optimize.bucketmapjoin.sortedmerge=false; set mapred.child.java.opts=-xmx8196m; set hive.optimize.skewjoin = true; set hive.exec.max.dynamic.partitions=10000; set hive.merge.smallfiles.avgsize=256000000; set hive.merge.size.per.task=256000000; set hive.hadoop.supports.splittable.combineinputformat=false; set hive.merge.orcfile.stripe.level=true; set hive.exec.orc.default.row.index.stride=50000; set hive.exec.orc.default.block.size=256000000; set mapred.child.java.opts=-xmx8196m; set mapreduce.map.memory.mb=4000; set mapreduce.reduce.memory.mb=4000;set mapreduce.reduce.memory.mb=4000;set hive.merge.mapfiles=true;set hive.merge.mapredfiles=true;set hive.vectorized.execution.enabled = true; set hive.vectorized.execution.reduce.enabled = true; set hive.cbo.enable=true;~kjfg254~2017-06-10 21:54:50.070027000
4~lg_mcm_adb_cntnt~complete_audit~complete_audit_sql~create table if not exists audit_db.lg_job_run_audit_table_lg_mcm_adb_cntnt as WITH cte_1 AS (SELECT 0 AS hive_record_count,0 AS dsl_layer_record_count,0 AS asl_layer_record_count,0 AS s3_to_hdfs_run_time,0 AS dsl_run_time,asl_run_time,work_flow,id FROM audit_db.lg_job_run_audit_table_stage_lg_mcm_adb_cntnt as a inner join (SELECT max(etl_time_stamp) as etl_time_stamp FROM audit_db.lg_job_run_audit_table_stage_lg_mcm_adb_cntnt WHERE  asl_run_time IS NOT NULL) as b on a.etl_time_stamp=b.etl_time_stamp ),cte_2 AS (SELECT sum(cast(hive_record_count AS int)) AS hive_record_count,sum(cast(dsl_layer_record_count AS int)) AS dsl_layer_record_count,sum(cast(asl_layer_record_count AS int)) AS asl_layer_record_count,sum(cast(s3_to_hdfs_run_time AS int)) AS s3_to_hdfs_run_time,sum(cast(dsl_run_time AS int)) AS dsl_run_time,sum(cast(asl_run_time AS int)) AS asl_run_time,work_flow,id FROM cte_1 GROUP BY work_flow,id ) , cte_3 AS (SELECT max(id) AS max_id,work_flow FROM audit_db.lg_job_run_audit_table WHERE work_flow='lg_mcm_adb_cntnt' GROUP BY work_flow),cte_4 AS ( SELECT count(1) AS hive_count,'lg_mcm_adb_cntnt' AS work_flow from edh_dsl.dsl_adb_cntnt as a left join edh_dsl.dds_cal_d as b on a.cal_dt_sk=b.cal_sk left join edh_dsl.dsl_adb_source as c on a.source=c.source ),cte_5 AS ( SELECT count(1) AS dsl_layer_record_count,'lg_mcm_adb_cntnt' AS work_flow FROM lg_base.lg_mcm_adb_cntnt WHERE load_date='${bus_date}' )SELECT DISTINCT COALESCE(b.max_id,0)+1 AS id,c.hive_count AS raw_record_count,d.dsl_layer_record_count AS dsl_layer_record_count,0 AS asl_layer_record_count,0 as s3_to_hdfs_run_time,0 as dsl_run_time,a.asl_run_time,current_timestamp() AS etl_time_stamp,a.work_flow FROM cte_2 AS a LEFT JOIN cte_3 AS b ON a.work_flow=b.work_flow LEFT JOIN cte_4 AS c ON c.work_flow=a.work_flow LEFT JOIN cte_5 AS d ON d.work_flow=a.work_flow ;INSERT INTO table audit_db.lg_job_run_audit_table select * from audit_db.lg_job_run_audit_table_lg_mcm_adb_cntnt;drop table if exists audit_db.lg_job_run_audit_table_lg_mcm_adb_cntnt~kjfg254~2017-06-10 21:54:51.501008000
5~lg_mcm_adb_cntnt~extract_and_email~extract_and_email_sql~select distinct concat('<td style=background-color:rgb(242,242,242)>',cast(raw_record_count as string),'</td>') AS source_table_count,concat('<td style=background-color:rgb(242,242,242)>',cast(dsl_layer_record_count as string),'</td>') AS lg_mcm_adb_cntnt_count,concat('<td style=background-color:rgb(242,242,242)>',cast(asl_run_time as string),'</td>') AS lg_mcm_adb_cntnt_source_to_target_run_time FROM audit_db.lg_job_run_audit_table as a  inner join (SELECT Max(etl_time_stamp) as etl_time_stamp FROM audit_db.lg_job_run_audit_table WHERE work_flow ='lg_mcm_adb_cntnt') as b on a.etl_time_stamp=b.etl_time_stamp WHERE work_flow = 'lg_mcm_adb_cntnt'~kjfg254~2017-06-10 21:54:51.918838000
6~lg_mcm_adb_cntnt~complete_audit~hive_sql_parameters~set hive.exec.dynamic.partition.mode=strict;~kjfg254~2017-06-10 21:54:51.918838000	 
7~lg_mcm_adb_cntnt~complete_audit~hive_compute_stats~select 1;~kjfg254~2017-06-10 21:54:51.918838000
